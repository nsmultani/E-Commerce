<div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px;">
  
  <!-- Category Sidebar -->
  <div class="category-sidebar" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: fit-content;">
    <h3 style="margin-top: 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Browse by Category</h3>
    
    <% Category.root_categories.ordered.includes(:subcategories).each do |category| %>
      <div class="category-group" style="margin-bottom: 15px;">
        <%= link_to category.name, category_path(category.slug), style: "font-weight: bold; color: #2c3e50; text-decoration: none; display: block; padding: 5px 0;" %>
        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;"><%= pluralize(category.products.count, 'product') %></div>
        
        <% if category.subcategories.any? %>
          <div style="margin-left: 15px; margin-top: 5px;">
            <% category.subcategories.ordered.each do |subcategory| %>
              <%= link_to subcategory.name, category_path(subcategory.slug), 
                         style: "color: #7f8c8d; text-decoration: none; display: block; padding: 2px 0; font-size: 14px;" %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
    
    <!-- Filter Counts -->
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ecf0f1;">
      <h4 style="color: #2c3e50; margin-bottom: 10px;">Filter Options</h4>
      <div style="font-size: 14px; color: #7f8c8d; line-height: 1.6;">
        <div>Featured: <%= Product.active.featured.count %></div>
        <div>On Sale: <%= Product.active.on_sale.count %></div>
        <div>New Products: <%= Product.active.new_products.count %></div>
        <div>Recently Updated: <%= Product.active.recently_updated.count %></div>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Enhanced Search Bar -->
    <div class="search-bar" style="background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
      <h3 style="margin-top: 0; color: #2c3e50; text-align: center; margin-bottom: 20px;">Search Products</h3>
      
      <%= form_with url: products_path, method: :get, local: true do |f| %>
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: end;">
          
          <!-- Keyword Search -->
          <div>
            <%= f.label :search, "Search Keywords:", style: "display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50;" %>
            <%= f.text_field :search, placeholder: "Enter product name or description...", value: params[:search],
                            style: "width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" %>
          </div>
          
          <!-- Category Selection for Search -->
          <div>
            <%= f.label :search_category_id, "Search Within Category:", style: "display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50;" %>
            <%= f.select :search_category_id, 
                        options_from_collection_for_select(@categories, :id, :full_name, params[:search_category_id]), 
                        { include_blank: "All Categories" },
                        { style: "padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" } %>
          </div>
          
          <!-- Search Button -->
          <div>
            <%= f.submit "Search Products", style: "padding: 12px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; white-space: nowrap;" %>
          </div>
        </div>
        
        <!-- Clear Search -->
        <% if params[:search].present? || params[:search_category_id].present? %>
          <div style="text-align: center; margin-top: 15px;">
            <%= link_to "Clear Search", products_path, style: "color: #e74c3c; text-decoration: none; font-size: 14px;" %>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Search Results Header -->
    <% if params[:search].present? %>
      <div class="search-results-header" style="background-color: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">
          Search Results for: "<strong><%= params[:search] %></strong>"
          <% if params[:search_category_id].present? %>
            <% search_category = Category.find_by(id: params[:search_category_id]) %>
            <% if search_category %>
              in category "<strong><%= search_category.full_name %></strong>"
            <% end %>
          <% end %>
        </h4>
        <div style="color: #7f8c8d; font-size: 14px;">
          Found <%= pluralize(@products.total_count, 'product') %> 
        </div>
      </div>
    <% end %>

    <!-- Filter Bar -->
    <div class="filter-bar" style="margin-bottom: 20px;">
      <%= link_to "All Products", products_path, 
                  class: (params[:featured].blank? && params[:on_sale].blank? && params[:new_products].blank? && params[:recently_updated].blank? && params[:category_id].blank? ? "active" : "") %>
      <%= link_to "Featured", products_path(featured: true), 
                  class: (params[:featured] == 'true' ? "active" : "") %>
      <%= link_to "On Sale", products_path(on_sale: true), 
                  class: (params[:on_sale] == 'true' ? "active" : "") %>
      <%= link_to "New Products", products_path(new_products: true), 
                  class: (params[:new_products] == 'true' ? "active" : "") %>
      <%= link_to "Recently Updated", products_path(recently_updated: true), 
                  class: (params[:recently_updated] == 'true' ? "active" : "") %>
    </div>

    <!-- Results Info -->
    <div style="text-align: center; margin-bottom: 20px;">
      <% unless params[:search].present? %>
        <% if params[:category_id].present? || params[:featured].present? || params[:on_sale].present? || params[:new_products].present? || params[:recently_updated].present? %>
          <h3>
            Showing <%= @products.total_count %> 
            <% if params[:category_id].present? %>
              <% category = Category.find_by(id: params[:category_id]) %>
              <%= "in #{category.name}" if category %>
            <% end %>
            <%= 'featured products' if params[:featured] == 'true' %>
            <%= 'products on sale' if params[:on_sale] == 'true' %>
            <%= 'new products' if params[:new_products] == 'true' %>
            <%= 'recently updated products' if params[:recently_updated] == 'true' %>
          </h3>
        <% else %>
          <h3>All Products (<%= @products.total_count %>)</h3>
        <% end %>
      <% end %>
    </div>

    <!-- Products Grid -->
    <div class="products-grid">
      <% @products.each do |product| %>
        <div class="product-card">
          <%= link_to product_path(product), style: "text-decoration: none; color: inherit;" do %>
            <% if product.primary_image.present? %>
              <%= image_tag product.primary_image, alt: product.name, class: "product-image" %>
            <% else %>
              <div class="product-image" style="display: flex; align-items: center; justify-content: center; color: #7f8c8d;">
                No Image
              </div>
            <% end %>
            
            <div class="product-info">
              <div class="product-categories">
                <%= product.category_names %>
              </div>
              
              <div class="product-name">
                <%= product.name %>
                
                <!-- Product Badges -->
                <div style="margin-top: 5px;">
                  <% if product.featured? %>
                    <span style="background-color: #f39c12; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-right: 3px;">FEATURED</span>
                  <% end %>
                  <% if product.on_sale? %>
                    <span style="background-color: #e74c3c; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-right: 3px;">SALE</span>
                  <% end %>
                  <% if product.is_new? %>
                    <span style="background-color: #27ae60; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-right: 3px;">NEW</span>
                  <% end %>
                  <% if product.recently_updated? %>
                    <span style="background-color: #9b59b6; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-right: 3px;">UPDATED</span>
                  <% end %>
                </div>
              </div>
              
              <!-- Highlight search terms -->
              <% if params[:search].present? %>
                <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px; font-style: italic;">
                  <% description_excerpt = truncate(product.description, length: 100) %>
                  <%= highlight(description_excerpt, params[:search], highlighter: '<mark style="background-color: #f1c40f; padding: 1px 3px;">\1</mark>') %>
                </div>
              <% end %>
              
              <div class="product-price <%= 'on-sale' if product.on_sale? %>">
                <% if product.on_sale? %>
                  <%= number_to_currency(product.sale_price) %>
                  <span class="original-price"><%= number_to_currency(product.price) %></span>
                <% else %>
                  <%= number_to_currency(product.price) %>
                <% end %>
              </div>
              
              <div class="product-stock <%= product.in_stock? ? 'in-stock' : 'out-of-stock' %>">
                <%= product.in_stock? ? "In Stock (#{product.stock_quantity})" : "Out of Stock" %>
              </div>
            </div>
          <% end %>
          
          <!-- Quick Add to Cart Button - This should be INSIDE the @products.each loop -->
          <div style="padding: 0 15px 15px 15px;">
            <% if product.in_stock? %>
              <%= form_with url: cart_add_path(product_id: product.id), method: :post, local: true do |f| %>
                <%= f.hidden_field :quantity, value: 1 %>
                <%= f.submit "Quick Add to Cart", 
                            style: "width: 100%; padding: 8px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.3s;" %>
              <% end %>
            <% else %>
              <button style="width: 100%; padding: 8px; background-color: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 14px;" disabled>
                Out of Stock
              </button>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Kaminari Pagination -->
    <%= paginate @products %>

    <!-- No products message -->
    <% if @products.empty? %>
      <div style="text-align: center; margin: 50px 0;">
        <h3>No products found</h3>
        <% if params[:search].present? %>
          <p>No products found for "<%= params[:search] %>"</p>
          <p>Try a different search term or category, or <%= link_to "browse all products", products_path, style: "color: #3498db;" %></p>
        <% else %>
          <p>Try adjusting your search or filter criteria.</p>
          <%= link_to "Browse All Products", products_path, style: "color: #3498db;" %>
        <% end %>
      </div>
    <% end %>
    
  </div>
</div>