<!-- app/views/payments/new.html.erb -->

<div class="payment-container" style="max-width: 1000px; margin: 0 auto;">
  <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Secure Payment</h1>

  <div style="display: grid; grid-template-columns: 1fr 400px; gap: 40px;">
    
    <!-- Payment Form -->
    <div class="payment-form" style="background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      
      <%= form_with model: @payment, url: payments_path, local: false, id: "payment-form" do |f| %>
        <% if @payment.errors.any? %>
          <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <h4>Please correct the following errors:</h4>
            <ul>
              <% @payment.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- Billing Information -->
        <h3 style="color: #2c3e50; margin-bottom: 20px;">Billing Information</h3>
        
        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <%= f.label :customer_name, "Full Name", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= f.text_field :customer_name, 
                            value: current_user.full_name,
                            style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>
          <div>
            <%= f.label :email, "Email Address", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= f.email_field :email, 
                             value: current_user.email,
                             style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>
        </div>

        <!-- Address fields -->
        <div class="form-group" style="margin-bottom: 20px;">
          <%= f.label :address_line_1, "Street Address", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
          <%= f.text_field :address_line_1, style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
        </div>

        <div class="form-group" style="margin-bottom: 20px;">
          <%= f.label :address_line_2, "Apartment, suite, etc. (optional)", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
          <%= f.text_field :address_line_2, style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
        </div>

        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
          <div>
            <%= f.label :city, "City", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= f.text_field :city, style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>
          <div>
            <%= f.label :province_id, "Province", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= f.select :province_id, 
                         options_from_collection_for_select(Province.ordered, :id, :name),
                         { prompt: "Select Province" },
                         { style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" } %>
          </div>
          <div>
            <%= f.label :postal_code, "Postal Code", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= f.text_field :postal_code, placeholder: "A1A 1A1", style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>
        </div>

        <!-- Payment Information -->
        <h3 style="color: #2c3e50; margin-bottom: 20px;">Payment Information</h3>
        
        <div id="card-element" style="padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: white; margin-bottom: 20px;">
          <!-- Stripe Elements will create form elements here -->
        </div>
        
        <div id="card-errors" role="alert" style="color: #e74c3c; margin-bottom: 20px; font-size: 14px;"></div>

        <!-- Hidden field for payment intent -->
        <input type="hidden" name="payment_intent_id" id="payment_intent_id">

        <!-- Submit button -->
        <div style="text-align: center;">
          <button id="submit-payment" style="background-color: #27ae60; color: white; padding: 15px 40px; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; width: 100%;">
            <span id="button-text">Pay Now - <%= number_to_currency(@total) %></span>
            <div id="spinner" class="hidden" style="display: none;">Processing...</div>
          </button>
        </div>
      <% end %>
    </div>

    <!-- Order Summary -->
    <div class="order-summary" style="background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: fit-content;">
      <h2 style="color: #2c3e50; margin-bottom: 20px;">Order Summary</h2>

      <!-- Cart Items -->
      <div class="summary-items">
        <% @cart_items.each do |item| %>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #ecf0f1;">
            <div>
              <div style="font-weight: bold; color: #2c3e50;"><%= item[:product].name %></div>
              <div style="color: #7f8c8d; font-size: 14px;">Qty: <%= item[:quantity] %> Ã— <%= number_to_currency(item[:product].display_price) %></div>
            </div>
            <div style="font-weight: bold; color: #2c3e50;">
              <%= number_to_currency(item[:total_price]) %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Totals -->
      <div class="summary-totals" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
          <span>Subtotal:</span>
          <span><%= number_to_currency(@subtotal) %></span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
          <span>Taxes:</span>
          <span><%= number_to_currency(@tax_amount) %></span>
        </div>
        <hr style="border: none; border-top: 2px solid #3498db; margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #2c3e50;">
          <span>Total:</span>
          <span><%= number_to_currency(@total) %></span>
        </div>
      </div>

      <!-- Security Notice -->
      <div style="margin-top: 20px; padding: 15px; background-color: #e8f5e8; border-radius: 6px; font-size: 14px; color: #2d5a2d;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 18px;">ðŸ”’</span>
          <div>
            <strong>Secure Payment</strong><br>
            Your payment information is encrypted and secure.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
// Initialize Stripe
const stripe = Stripe('<%= @stripe_publishable_key %>');
const elements = stripe.elements();

// Create an instance of the card Element
const card = elements.create('card', {
  style: {
    base: {
      fontSize: '16px',
      color: '#424770',
      '::placeholder': {
        color: '#aab7c4',
      },
    },
    invalid: {
      color: '#9e2146',
    },
  },
});

// Add an instance of the card Element into the `card-element` div
card.mount('#card-element');

// Handle real-time validation errors from the card Element
card.on('change', function(event) {
  const displayError = document.getElementById('card-errors');
  if (event.error) {
    displayError.textContent = event.error.message;
  } else {
    displayError.textContent = '';
  }
});

// Handle form submission
const form = document.getElementById('payment-form');
const submitButton = document.getElementById('submit-payment');

form.addEventListener('submit', async function(event) {
  event.preventDefault();
  
  submitButton.disabled = true;
  document.getElementById('button-text').style.display = 'none';
  document.getElementById('spinner').style.display = 'block';

  const {error, paymentIntent} = await stripe.confirmCardPayment(
    '<%= @client_secret %>', {
      payment_method: {
        card: card,
        billing_details: {
          name: document.querySelector('input[name="payment[customer_name]"]').value,
          email: document.querySelector('input[name="payment[email]"]').value,
        }
      }
    }
  );

  if (error) {
    // Show error to customer
    const errorElement = document.getElementById('card-errors');
    errorElement.textContent = error.message;
    
    submitButton.disabled = false;
    document.getElementById('button-text').style.display = 'block';
    document.getElementById('spinner').style.display = 'none';
  } else {
    // Payment succeeded
    document.getElementById('payment_intent_id').value = paymentIntent.id;
    
    // Submit the form to create the order
    const formData = new FormData(form);
    
    fetch('<%= payments_path %>', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      }
    }).then(response => {
      if (response.ok) {
        return response.json();
      }
      throw new Error('Network response was not ok.');
    }).then(data => {
      if (data.success) {
        window.location.href = data.redirect_url;
      } else {
        throw new Error(data.error || 'Payment processing failed');
      }
    }).catch(error => {
      const errorElement = document.getElementById('card-errors');
      errorElement.textContent = 'Payment processing failed. Please try again.';
      
      submitButton.disabled = false;
      document.getElementById('button-text').style.display = 'block';
      document.getElementById('spinner').style.display = 'none';
    });
  }
});
</script>